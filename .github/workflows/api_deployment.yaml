# api.py updated -> re-deploy to gcp

name: API update pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'src/mlops_project/api.py'
  workflow_dispatch:
    inputs:
      project_id:
        description: 'GCP Project ID'
        required: false
      region:
        description: 'GCP Region'
        required: false

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID || github.event.inputs.project_id || 'vibeops-483814' }}
  REGION: ${{ vars.GCP_REGION || github.event.inputs.region || 'europe-west1' }}
  ARTIFACT_REGISTRY: ${{ vars.GCP_ARTIFACT_REGISTRY || 'dtu-vibe-ops' }}

jobs:
  api-update:
    name: Deploy API to GCP Cloud Run
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
      actions: read

    steps:
      - name: Wait for Unit Tests to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-regexp: '^test \(.+\)$'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Checkout code
        uses: actions/checkout@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv sync --all-groups

      - name: DVC pull
        run: |
          uv run dvc pull models.dvc --remote gcs_models_remote

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Deploy to Cloud Run
        run: |
          uv run invoke deploy-to-cloud-run --project-id=${{ env.PROJECT_ID }} --region=${{ env.REGION }} --artifact-registry=${{ env.ARTIFACT_REGISTRY }}
