name: Build and Push Docker Images

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    paths:
      - 'dockerfiles/**'
      - 'src/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/docker-build.yaml'
  workflow_dispatch:  # Allow manual triggering

env:
  REGISTRY: docker.io

jobs:
  build-train:
    name: Build and Push Train Docker Image
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Verify Docker Hub secrets and variables
        if: github.event_name == 'push'
        run: |
          if [ -z "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
            echo "ERROR: DOCKER_HUB_USERNAME secret is empty or not set in production environment"
            echo "Please go to: Settings > Environments > production > Add secret"
            exit 1
          fi
          if [ -z "${{ secrets.DOCKER_HUB_TOKEN }}" ]; then
            echo "ERROR: DOCKER_HUB_TOKEN secret is empty or not set in production environment"
            echo "Please go to: Settings > Environments > production > Add secret"
            exit 1
          fi
          if [ -z "${{ vars.DOCKER_HUB_REPOSITORY }}" ]; then
            echo "ERROR: DOCKER_HUB_REPOSITORY variable is empty or not set in production environment"
            echo "Please go to: Settings > Environments > production > Add variable"
            exit 1
          fi
          echo "All secrets and variables verified successfully"

      - name: Log in to Docker Hub
        if: github.event_name == 'push'
        run: |
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin docker.io

      - name: Build the Docker image
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            docker build . --file dockerfiles/train.dockerfile \
              --tag docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}-train:${{ github.sha }} \
              --tag docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}-train:latest
          else
            docker build . --file dockerfiles/train.dockerfile \
              --tag ${{ vars.DOCKER_HUB_REPOSITORY }}-train:${{ github.sha }}
          fi

      - name: Push Docker image
        if: github.event_name == 'push'
        run: |
          docker push docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}-train:${{ github.sha }}
          docker push docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}-train:latest

  build-inference:
    name: Build and Push Inference Docker Image
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Verify Docker Hub secrets and variables
        if: github.event_name == 'push'
        run: |
          if [ -z "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
            echo "ERROR: DOCKER_HUB_USERNAME secret is empty or not set in production environment"
            echo "Please go to: Settings > Environments > production > Add secret"
            exit 1
          fi
          if [ -z "${{ secrets.DOCKER_HUB_TOKEN }}" ]; then
            echo "ERROR: DOCKER_HUB_TOKEN secret is empty or not set in production environment"
            echo "Please go to: Settings > Environments > production > Add secret"
            exit 1
          fi
          if [ -z "${{ vars.DOCKER_HUB_REPOSITORY }}" ]; then
            echo "ERROR: DOCKER_HUB_REPOSITORY variable is empty or not set in production environment"
            echo "Please go to: Settings > Environments > production > Add variable"
            exit 1
          fi
          echo "All secrets and variables verified successfully"

      - name: Log in to Docker Hub
        if: github.event_name == 'push'
        run: |
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin docker.io

      - name: Build the Docker image
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            docker build . --file dockerfiles/inference.dockerfile \
              --tag docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}-inference:${{ github.sha }} \
              --tag docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}-inference:latest
          else
            docker build . --file dockerfiles/inference.dockerfile \
              --tag ${{ vars.DOCKER_HUB_REPOSITORY }}-inference:${{ github.sha }}
          fi

      - name: Push Docker image
        if: github.event_name == 'push'
        run: |
          docker push docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}-inference:${{ github.sha }}
          docker push docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}-inference:latest
