name: Deploy Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'src/**'
      - 'README.md'
      - '.github/workflows/deploy_docs.yaml'
  
  # Allow manual deployment
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          version: "latest"
      
      - name: Set up Python
        run: uv python install 3.12
      
      - name: Install dependencies
        run: uv sync --group dev
      
      - name: Configure Git for GitHub Actions
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Build documentation
        working-directory: docs
        run: |
          uv run mkdocs build --clean --strict --verbose
        env:
          MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload documentation artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/site
  
  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Check deployment health
        run: |
          # Wait for deployment to be ready
          sleep 30
          
          # Get the deployed URL (would be set by GitHub Pages)
          DOCS_URL="https://dtu-group-36.github.io/dtu-vibe-ops-02476/"
          
          # Check if documentation is accessible
          curl -f -s -L "$DOCS_URL" > /dev/null
          
          echo "âœ… Documentation successfully deployed to: $DOCS_URL"
      
      - name: Test documentation links
        run: |
          # Install link checker
          npm install -g linkinator
          
          # Check for broken links
          linkinator "https://dtu-group-36.github.io/dtu-vibe-ops-02476/" \
            --recurse \
            --skip "^(?!https://dtu-group-36\.github\.io/dtu-vibe-ops-02476/).*" \
            --format csv \
            --output links-report.csv
        continue-on-error: true
      
      - name: Upload link check report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: link-check-report
          path: links-report.csv